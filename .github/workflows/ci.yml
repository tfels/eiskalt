name: CI

on:
  push:
    branches: ['**']
  pull_request:
    branches: ['**']

permissions:
  contents: read
  checks: write

jobs:
  build:
    name: Build (Gradle)
    runs-on: ubuntu-latest
    env:
      JAVA_TOOL_OPTIONS: -Dfile.encoding=UTF8
    steps:
      - name: Checkout
        uses: actions/checkout@v6
      - name: Set up JDK 21
        uses: actions/setup-java@v5
        with:
          distribution: 'temurin'
          java-version: '21'
          cache: gradle

      - name: Debug Java / Android env
        run: |
          echo "JAVA_HOME=$JAVA_HOME"
          java -version || true
          echo "ANDROID_SDK_ROOT=$ANDROID_SDK_ROOT"

      - name: Install Android cmdline-tools and SDK (API 36)
        run: |
          SDK_ROOT=${ANDROID_SDK_ROOT:-$HOME/Android/Sdk}
          mkdir -p "$SDK_ROOT"
          export ANDROID_SDK_ROOT="$SDK_ROOT"
          echo "Using ANDROID_SDK_ROOT=$ANDROID_SDK_ROOT"
          if [ ! -x "$ANDROID_SDK_ROOT/cmdline-tools/latest/bin/sdkmanager" ]; then
            curl -sS https://dl.google.com/android/repository/commandlinetools-linux-9477386_latest.zip -o /tmp/cmdline.zip
            unzip -q /tmp/cmdline.zip -d /tmp/cmdline
            mkdir -p "$ANDROID_SDK_ROOT/cmdline-tools"
            mv /tmp/cmdline/cmdline-tools "$ANDROID_SDK_ROOT/cmdline-tools/latest"
          fi
          yes | "$ANDROID_SDK_ROOT/cmdline-tools/latest/bin/sdkmanager" --sdk_root="$ANDROID_SDK_ROOT" --install "platform-tools" "platforms;android-36" "build-tools;36.0.0" || true

      - name: Build with Gradle
        run: ./gradlew assembleDebug --no-daemon --stacktrace

      # now run our unit test
      - name: Run unit tests
        run: ./gradlew test --no-daemon --stacktrace

      - name: Publish Unit Test Results
        uses: dorny/test-reporter@v2
        if: success() || failure()
        with:
          name: Unit Tests Results
          path: 'app/build/test-results/testDebugUnitTest/*.xml'
          reporter: java-junit

      # run the linter
      - name: Run lint
        run: ./gradlew lintDebug --no-daemon --stacktrace
